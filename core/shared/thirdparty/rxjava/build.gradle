buildscript {
    // HACK: Allow android studio to support older versions of Gradle,
    // since the J2ObjC plugin only supports up-to Gradle 2.8
    // See: https://github.com/j2objc-contrib/j2objc-gradle/issues/613
    // and https://github.com/j2objc-contrib/j2objc-gradle/issues/568#issuecomment-236069034
    System.properties['com.android.build.gradle.overrideVersionCheck'] = 'true'
    repositories { jcenter() }

  dependencies {
      classpath 'com.netflix.nebula:gradle-rxjava-project-plugin:4.0.0'
      classpath files('../../../misc/j2objc-gradle-0.6.3-modified-alpha-SNAPSHOT.jar')

  }
}

description = 'RxJava: Reactive Extensions for the JVM â€“ a library for composing asynchronous and event-based programs using observable sequences for the Java VM.'

apply plugin: 'java'
apply plugin: 'nebula.rxjava-project'
// HACK Add support for J2ObjC
apply plugin: 'com.github.j2objccontrib.j2objcgradle'

dependencies {
    testCompile 'junit:junit:4.12'
    testCompile 'org.mockito:mockito-core:1.8.5'

    perfCompile 'org.openjdk.jmh:jmh-core:1.11.3'
    perfCompile 'org.openjdk.jmh:jmh-generator-annprocess:1.11.3'
}

javadoc {
    exclude "**/rx/internal/**"
    exclude "**/test/**"
    exclude "**/perf/**"
    options {
        windowTitle = "RxJava Javadoc ${project.version}"
    }
    // Clear the following options to make the docs consistent with the old format
    options.addStringOption('top').value = ''
    options.addStringOption('doctitle').value = ''
    options.addStringOption('header').value = ''
    if (JavaVersion.current().isJava7()) {
        // "./gradle/stylesheet.css" only supports Java 7
        options.addStringOption('stylesheetfile', rootProject.file('./gradle/stylesheet.css').toString())
    }
}

// support for snapshot/final releases with the various branches RxJava uses
//nebulaRelease {
//    addReleaseBranchPattern(/\d+\.\d+\.\d+/)
//    addReleaseBranchPattern('HEAD')
//}

if (project.hasProperty('release.useLastTag')) {
    tasks.prepare.enabled = false
}

test{
     maxHeapSize = "2g"
}

// Plugin settings; put these at the bottom of the file.
j2objcConfig {
    // Support current versions of J2ObjC
    // see: https://github.com/j2objc-contrib/j2objc-gradle/issues/621
    j2objcVersion "1.1"
    // Sets up libraries you depend on
    autoConfigureDeps true

    // Add Prefix to Transpiled code
    //translateArgs '--prefixes', 'j2objcprefixes.properties'
    // Include Java line numbers in Objective-C source files.
    translateArgs '-g'
    // Use ARC
    translateArgs '-use-arc'
    extraObjcCompilerArgs '-fobjc-arc', '-Wno-deprecated-declarations'



    // Omit these two lines if you don't configure your Xcode project with CocoaPods
    //xcodeProjectDir '../../ios'  //  suggested directory name
    //xcodeTargetsIos 'IOS-APP', 'IOS-APPTests'  // replace with your iOS targets
    testPattern {
        // Exclude these tests since they are failing or won't compile.
        // FIXME not sure why, but the gradle plugin is ignoring this right now,
        // so we are just skipping transpilation all-together below.
        exclude '**/SchedulerTests.java'
        exclude '**/OperatorMapTest.java'
        exclude '**/ExecutorSchedulerTest.java'
        exclude '**/ComputationSchedulerTests.java'
        exclude '**/IoSchedulerTest.java'
        exclude '**/NewThreadSchedulerTest.java'
        exclude '**/CovarianceTest.java'
        exclude '**/MergeTests.java'
        exclude '**/CombineLatestTests.java'
        exclude '**/ConcatTests.java'
        exclude '**/ReduceTests.java'
        exclude '**/ZipTests.java'
        exclude '**/BackpressureTests.java'
        exclude '**/CompositeExceptionTest.java'
        exclude '**/ReplaySubjectConcurrencyTest.java'
        exclude '**/ActionsTest.java'
        exclude '**/TestSingleThreadedObservable.java'
        exclude '**/SubscribersTest.java'
        exclude '**/OperatorPublishTest.java'
        exclude '**/CachedObservableTest.java'
        exclude '**/AssertObservableTest.java'
        exclude '**/OperatorZipTest.java'
        exclude '**/OnSubscribeRefCountTest.java'
        exclude '**/SafeSubscriberTest.java'
        exclude '**/ReplaySubjectBoundedConcurrencyTest.java'
        exclude '**/SyncOnSubscribeTest.java'
        exclude '**/SubscriptionListTest.java'
        exclude '**/AsyncSubjectTest.java'
        exclude '**/OperatorMapTest.java'
        exclude '**/OperatorFlatMapTest.java'
        exclude '**/OnNextValueTest.java'
        exclude '**/AssertObservable.java'
        exclude '**/TestObstructionDetection.java'
        exclude '**/CompositeSubscriptionTest.java'
        exclude '**/SafeObserverTest.java'
        exclude '**/PublishSubjectTest.java'
        exclude '**/FunctionsTest.java'
        exclude '**/NewThreadWorkerTest.java'
        exclude '**/ReplaySubjectTest.java'
        exclude '**/AbstractSchedulerTests.java'
        exclude '**/OperatorReplayTest.java'
        exclude '**/AbstractSchedulerConcurrencyTests.java'
        exclude '**/NotificationTest.java'
        exclude '**/OperatorCastTest.java'
        exclude '**/OperatorMergeDelayErrorTest.java'
        exclude '**/BehaviorSubjectTest.java'
        exclude '**/CapturingUncaughtExceptionHandler.java'
        // Test Utils Not actual tests
        exclude '**/CompletableTest.java'
        exclude '**/EventStream.java'
        exclude '**/TestException.java'
        exclude '**/JCToolsQueueTests.java'
        exclude '**/OperatorTester.java'
        // Issues with Mockito causing Seg Faults or incompatible with JUnit Version
        exclude '**/SingleTest.java'
        exclude '**/internal/operators/*.java'
        exclude '**/AsyncOnSubscribeTest.java'
        exclude '**/RxRingBufferBase.java'
        exclude '**/SerialSubscriptionTests.java'
        // Issues with 100% CPU Usage
        exclude '**/ExceptionsTest.java'
        // Failing Test
        exclude '**/TestObserverTest.java'
        exclude '**/TestSubscriberTest.java'
        exclude '**/.ObserversTest.java'
        exclude '**/RxJavaPluginsTest.java'



    }

    translatePattern {
        // Exclude these tests since they won't compile in J2ObjC
        exclude '**/SchedulerTests.java'
        exclude '**/OperatorMapTest.java'
        exclude '**/ExecutorSchedulerTest.java'
        exclude '**/ComputationSchedulerTests.java'
        exclude '**/IoSchedulerTest.java'
        exclude '**/NewThreadSchedulerTest.java'
        exclude '**/CovarianceTest.java'
        exclude '**/MergeTests.java'
        exclude '**/CombineLatestTests.java'
        exclude '**/ConcatTests.java'
        exclude '**/ReduceTests.java'
        exclude '**/ZipTests.java'
        exclude '**/BackpressureTests.java'
        exclude '**/CompositeExceptionTest.java'
        exclude '**/ReplaySubjectConcurrencyTest.java'
        exclude '**/ActionsTest.java'
        exclude '**/TestSingleThreadedObservable.java'
        exclude '**/SubscribersTest.java'
        exclude '**/OperatorPublishTest.java'
        exclude '**/CachedObservableTest.java'
        exclude '**/AssertObservableTest.java'
        exclude '**/OperatorZipTest.java'
        exclude '**/OnSubscribeRefCountTest.java'
        exclude '**/SafeSubscriberTest.java'
        exclude '**/ReplaySubjectBoundedConcurrencyTest.java'
        exclude '**/SyncOnSubscribeTest.java'
        exclude '**/SubscriptionListTest.java'
        exclude '**/AsyncSubjectTest.java'
        exclude '**/OperatorMapTest.java'
        exclude '**/OperatorFlatMapTest.java'
        exclude '**/OnNextValueTest.java'
        exclude '**/TestObstructionDetection.java'
        exclude '**/ObservableTests.java'
        exclude '**/CompositeSubscriptionTest.java'
        exclude '**/SafeObserverTest.java'
        exclude '**/PublishSubjectTest.java'
        exclude '**/FunctionsTest.java'
        exclude '**/NewThreadWorkerTest.java'
        exclude '**/ReplaySubjectTest.java'
        exclude '**/OperatorReplayTest.java'
        exclude '**/AbstractSchedulerConcurrencyTests.java'
        exclude '**/OperatorDoOnEachTest.java'
        exclude '**/NotificationTest.java'
        exclude '**/OperatorCastTest.java'
        exclude '**/OperatorMergeDelayErrorTest.java'
        exclude '**/BehaviorSubjectTest.java'
        // Won't Compile
        exclude '**/AbstractSchedulerTests.java'
        //exclude '**/RxRingBufferSpscTestL.java'
        //exclude '**/RxRingBufferSpmcTestL.java'
        exclude '**/TestObstructionDetectionTest.java'
        //exclude '**/RxRingBufferWithoutUnsafeTestL.java'
        exclude '**/ImmediateSchedulerTest.java'
        exclude '**/TrampolineSchedulerTest.java'


    }
    finalConfigure()          // Must be last call to configuration
}

test {
    testLogging {
        // Provide full exception info on failure, instead
        // of just pointing to an HTML file.
        showStandardStreams = true
        exceptionFormat 'full'
        events "passed", "skipped", "failed", "standardOut", "standardError"
    }
    afterTest { desc, result ->
        println "Executing test ${desc.name} [${desc.className}] with result: ${result.resultType}"
    }
}

j2objcTest {
    enabled = false
}